# ğŸ§µ C++ çº¿ç¨‹æ±  (ThreadPool)

ä¸€ä¸ªé«˜æ•ˆã€æ˜“ç”¨çš„C++çº¿ç¨‹æ± å®ç°ï¼Œæ”¯æŒä»»æ„å‡½æ•°å’Œå‚æ•°çš„å¼‚æ­¥æ‰§è¡Œã€‚ğŸš€

## âœ¨ ç‰¹æ€§

- ğŸ”§ æ”¯æŒä»»æ„å‡½æ•°å’Œå‚æ•°çš„å¼‚æ­¥æ‰§è¡Œ
- ğŸ”® ä½¿ç”¨ `std::future` è·å–å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼
- ğŸ”’ çº¿ç¨‹å®‰å…¨çš„ä»»åŠ¡é˜Ÿåˆ—
- ğŸ”„ è‡ªåŠ¨çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†
- âš ï¸ æ”¯æŒå¼‚å¸¸å¤„ç†
- ğŸ†• ç°ä»£C++17ç‰¹æ€§

## ğŸ“– ä½¿ç”¨æ–¹æ³•

### ğŸ¯ åŸºæœ¬ç”¨æ³•

```cpp
#include "thread_pool.hpp"

// åˆ›å»ºæœ‰4ä¸ªå·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹æ± 
ThreadPool pool(4);

// æäº¤ä»»åŠ¡å¹¶è·å–future
auto result = pool.enqueue([](int x, int y) {
    return x + y;
}, 10, 20);

// è·å–ç»“æœ
int sum = result.get(); // sum = 30
```

### ğŸ› ï¸ æ”¯æŒçš„ä»»åŠ¡ç±»å‹

#### 1ï¸âƒ£ æœ‰è¿”å›å€¼çš„å‡½æ•°
```cpp
int add(int a, int b) {
    return a + b;
}

auto future = pool.enqueue(add, 5, 10);
int result = future.get(); // 15
```

#### 2ï¸âƒ£ æ— è¿”å›å€¼çš„å‡½æ•°
```cpp
void print_message(const std::string& msg) {
    std::cout << msg << std::endl;
}

auto future = pool.enqueue(print_message, "Hello World");
future.get(); // ç­‰å¾…ä»»åŠ¡å®Œæˆ
```

#### 3ï¸âƒ£ Lambdaè¡¨è¾¾å¼
```cpp
auto future = pool.enqueue([](int x) -> int {
    return x * x;
}, 5);
int result = future.get(); // 25
```

#### 4ï¸âƒ£ ç±»æˆå‘˜å‡½æ•°
```cpp
class Calculator {
public:
    int multiply(int a, int b) { return a * b; }
};

Calculator calc;
auto future = pool.enqueue(&Calculator::multiply, &calc, 3, 4);
int result = future.get(); // 12
```

## âš™ï¸ ç¼–è¯‘è¦æ±‚

- ğŸ“‹ C++17 æˆ–æ›´é«˜ç‰ˆæœ¬
- ğŸ§µ æ”¯æŒpthreadçš„ç¼–è¯‘å™¨

### ğŸ”¨ ç¼–è¯‘å‘½ä»¤
```bash
g++ -std=c++17 -pthread -O2 -o your_program your_program.cpp
```

## ğŸ“š API å‚è€ƒ

### ğŸ—ï¸ æ„é€ å‡½æ•°
```cpp
ThreadPool(size_t num_threads)
```
åˆ›å»ºæŒ‡å®šæ•°é‡å·¥ä½œçº¿ç¨‹çš„çº¿ç¨‹æ± ã€‚

### ğŸ“ enqueue æ–¹æ³•
```cpp
template<class F, class... Args>
auto enqueue(F&& f, Args&&... args) -> std::future<typename std::invoke_result<F, Args...>::type>
```
å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ï¼Œè¿”å›ä¸€ä¸ª `std::future` å¯¹è±¡ç”¨äºè·å–ç»“æœã€‚

**ğŸ“¥ å‚æ•°:**
- `f`: è¦æ‰§è¡Œçš„å‡½æ•°æˆ–å¯è°ƒç”¨å¯¹è±¡
- `args`: å‡½æ•°å‚æ•°

**ğŸ“¤ è¿”å›å€¼:**
- `std::future<return_type>`: ç”¨äºè·å–å¼‚æ­¥æ‰§è¡Œç»“æœçš„futureå¯¹è±¡

**ğŸš« å¼‚å¸¸:**
- å¦‚æœçº¿ç¨‹æ± å·²ç»åœæ­¢ï¼Œä¼šæŠ›å‡º `std::runtime_error`

## ğŸ—ï¸ è®¾è®¡åŸç†

### ğŸ”§ æ ¸å¿ƒç»„ä»¶

1. **ğŸ§µ å·¥ä½œçº¿ç¨‹å‘é‡** (`workers`): å­˜å‚¨æ‰€æœ‰å·¥ä½œçº¿ç¨‹
2. **ğŸ“‹ ä»»åŠ¡é˜Ÿåˆ—** (`tasks`): çº¿ç¨‹å®‰å…¨çš„ä»»åŠ¡é˜Ÿåˆ—
3. **ğŸ”’ äº’æ–¥é”** (`queue_mutex`): ä¿æŠ¤ä»»åŠ¡é˜Ÿåˆ—çš„è®¿é—®
4. **ğŸ“¢ æ¡ä»¶å˜é‡** (`condition`): ç”¨äºçº¿ç¨‹é—´çš„åŒæ­¥
5. **ğŸ›‘ åœæ­¢æ ‡å¿—** (`stop`): æ§åˆ¶çº¿ç¨‹æ± çš„ç”Ÿå‘½å‘¨æœŸ

### ğŸ”„ å·¥ä½œæµç¨‹

1. ğŸš€ æ„é€ æ—¶åˆ›å»ºæŒ‡å®šæ•°é‡çš„å·¥ä½œçº¿ç¨‹
2. â³ å·¥ä½œçº¿ç¨‹å¾ªç¯ç­‰å¾…ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡
3. ğŸ“¦ `enqueue` æ–¹æ³•å°†ä»»åŠ¡åŒ…è£…æˆ `std::packaged_task` å¹¶åŠ å…¥é˜Ÿåˆ—
4. âš¡ å·¥ä½œçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡å¹¶æ‰§è¡Œ
5. ğŸ ææ„æ—¶è®¾ç½®åœæ­¢æ ‡å¿—ï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ

## ğŸ§ª æµ‹è¯•

é¡¹ç›®åŒ…å«å®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ï¼š

```bash
# ğŸ”¨ ç¼–è¯‘æµ‹è¯•ç¨‹åº
g++ -std=c++17 -pthread -O2 -o test_thread_pool test_thread_pool.cpp

# ğŸš€ è¿è¡Œæµ‹è¯•
./test_thread_pool
```

æµ‹è¯•åŒ…æ‹¬ï¼š
- âœ… åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- ğŸ”€ å¹¶å‘ä»»åŠ¡æµ‹è¯•  
- ğŸƒâ€â™‚ï¸ æ€§èƒ½æµ‹è¯•
- âš ï¸ å¼‚å¸¸å¤„ç†æµ‹è¯•
- ğŸ’€ çº¿ç¨‹æ± é”€æ¯æµ‹è¯•
- ğŸ”§ Lambdaè¡¨è¾¾å¼æµ‹è¯•

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ğŸ§µ çº¿ç¨‹æ•°é‡**: é€šå¸¸è®¾ç½®ä¸º CPU æ ¸å¿ƒæ•°æˆ–ç¨å¤šä¸€äº›
2. **âš–ï¸ ä»»åŠ¡ç²’åº¦**: é¿å…æäº¤è¿‡äºç»†ç²’åº¦çš„ä»»åŠ¡ï¼Œä¼šå¢åŠ è°ƒåº¦å¼€é”€
3. **âš ï¸ å¼‚å¸¸å¤„ç†**: ä»»åŠ¡ä¸­çš„å¼‚å¸¸ä¼šè¢«ä¼ æ’­åˆ° `future.get()` è°ƒç”¨å¤„
4. **â™»ï¸ ç”Ÿå‘½å‘¨æœŸ**: ç¡®ä¿çº¿ç¨‹æ± å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸè¦†ç›–æ‰€æœ‰ä½¿ç”¨æœŸé—´

## ğŸš€ æ€§èƒ½ç‰¹ç‚¹

- âš¡ ä½å»¶è¿Ÿçš„ä»»åŠ¡è°ƒåº¦
- ğŸ’¾ é«˜æ•ˆçš„å†…å­˜ä½¿ç”¨
- ğŸ”¥ æ”¯æŒé«˜å¹¶å‘ä»»åŠ¡æ‰§è¡Œ
- âš–ï¸ è‡ªåŠ¨è´Ÿè½½å‡è¡¡

## ğŸ“„ è®¸å¯è¯

ğŸ“ƒ MIT License
